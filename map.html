<!DOCTYPE html>
<html>
<head>
    <title>Выбор адреса на карте</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=e054d541-611b-4d9b-b108-bf53d7b73878" type="text/javascript"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Arial', sans-serif;
            background: #1c1c1c;
            color: #ffffff;
        }
        #map {
            width: 100%;
            height: 70%;
        }
        #controls {
            width: 100%;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #2c2f33;
            color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 20px;
        }
        #address {
            font-size: 18px;
            margin-bottom: 10px;
            padding: 10px;
            border: 2px solid #7289da;
            border-radius: 5px;
            background: #23272a;
            width: 90%;
            text-align: center;
        }
        #select-address {
            padding: 10px 20px;
            font-size: 16px;
            background: #7289da;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #select-address:hover {
            background: #5a6faa;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div id="address">Кликните на карту, чтобы выбрать адрес</div>
        <button id="select-address">Выбрать адрес</button>
    </div>
    <div id="map"></div>

    <script>
        ymaps.ready(init);

        let selectedAddress = "";
        let selectedCoords = [];
        let userLocation = [];

        function init() {
            // Создаем карту.
            var map = new ymaps.Map("map", {
                center: [55.751574, 37.573856], // Координаты центра карты (Москва).
                zoom: 10
            });

            // Переменная для хранения маркера.
            var placemark;

            // Получаем текущую геолокацию пользователя.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    map.setCenter(userLocation, 14);
                }, function() {
                    alert('Не удалось определить ваше местоположение');
                });
            }

            // Обработчик клика по карте.
            map.events.add('click', function (e) {
                var coords = e.get('coords');

                // Если маркер уже существует, перемещаем его.
                if (placemark) {
                    placemark.geometry.setCoordinates(coords);
                } else {
                    // Иначе создаем новый маркер.
                    placemark = new ymaps.Placemark(coords, {}, {
                        preset: 'islands#redIcon'
                    });
                    map.geoObjects.add(placemark);
                }

                // Получаем адрес по координатам.
                ymaps.geocode(coords).then(function (res) {
                    var firstGeoObject = res.geoObjects.get(0);
                    selectedAddress = firstGeoObject.getAddressLine();
                    selectedCoords = coords;
                    document.getElementById('address').innerText = selectedAddress;
                });
            });

            // Обработчик нажатия на кнопку "Выбрать адрес".
            document.getElementById('select-address').onclick = function () {
                if (selectedAddress && userLocation.length > 0) {
                    // Отправляем данные обратно в Telegram.
                    Telegram.WebApp.sendData(JSON.stringify({
                        address: selectedAddress,
                        coords: selectedCoords,
                        userLocation: userLocation
                    }));
                } else {
                    alert("Пожалуйста, выберите адрес на карте и убедитесь, что ваше местоположение определено.");
                }
            };
        }
    </script>
</body>
</html>
